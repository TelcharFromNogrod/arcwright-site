<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout ‚Äî Arcwright</title>
  <script defer data-domain="arcwright-site-production.up.railway.app" src="https://plausible.io/js/script.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%230a0a0a'/><text x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-family='system-ui' font-weight='800' font-size='20' fill='%23f59e0b'>A</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0a; --surface: #141414; --border: #222;
      --text: #e8e8e8; --muted: #888; --accent: #f59e0b; --accent2: #3b82f6;
      --green: #22c55e; --red: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    
    .checkout { max-width: 440px; width: 100%; margin: 24px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 32px; }
    .logo { font-size: 1.2rem; font-weight: 700; margin-bottom: 24px; text-align: center; }
    .logo span { color: var(--accent); }
    
    h2 { font-size: 1.3rem; margin-bottom: 4px; }
    .price-tag { font-size: 1.8rem; font-weight: 800; color: var(--accent); margin-bottom: 24px; }
    
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 6px; }
    input, select {
      width: 100%; padding: 12px 14px; background: var(--bg); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-size: 0.95rem; outline: none; transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--accent); }
    select { cursor: pointer; }
    
    .btn {
      width: 100%; padding: 14px; background: var(--accent); color: #000; font-weight: 700;
      font-size: 1rem; border: none; border-radius: 10px; cursor: pointer; transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    
    .payment-info { text-align: center; }
    .qr-container { margin: 20px auto; display: flex; justify-content: center; }
    .qr-container canvas { border-radius: 12px; }
    .address-box {
      font-family: monospace; font-size: 0.75rem; background: var(--bg); padding: 12px;
      border-radius: 10px; word-break: break-all; color: var(--accent2); margin: 12px 0;
      cursor: pointer; position: relative;
    }
    .address-box:hover::after {
      content: 'Click to copy'; position: absolute; top: -24px; left: 50%; transform: translateX(-50%);
      font-size: 0.7rem; color: var(--muted); font-family: -apple-system, sans-serif;
    }
    .amount-box { font-size: 1.4rem; font-weight: 700; color: var(--accent); margin: 8px 0; }
    .amount-usd { font-size: 0.85rem; color: var(--muted); }
    .timer { font-size: 0.85rem; color: var(--muted); margin-top: 8px; }
    .status-badge {
      display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-top: 16px;
    }
    .status-pending { background: rgba(245,158,11,0.15); color: var(--accent); }
    .status-confirmed { background: rgba(34,197,94,0.15); color: var(--green); }
    .status-expired { background: rgba(239,68,68,0.15); color: var(--red); }
    
    .step { display: none; }
    .step.active { display: block; }
    
    .back-link { display: block; text-align: center; margin-top: 16px; color: var(--muted); text-decoration: none; font-size: 0.85rem; }
    .back-link:hover { color: var(--text); }
    
    .chain-info { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .crypto-preview { font-size: 0.85rem; color: var(--muted); margin-top: 8px; min-height: 20px; }
    
    .crypto-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .crypto-option {
      display: block; cursor: pointer; border: 2px solid var(--border); border-radius: 12px;
      padding: 12px 10px; transition: border-color 0.2s, background 0.2s;
    }
    .crypto-option:hover { border-color: #444; }
    .crypto-option.selected { border-color: var(--accent); background: rgba(245,158,11,0.06); }
    .crypto-option input[type="radio"] { display: none; }
    .crypto-option-inner { display: flex; align-items: center; gap: 10px; }
    .crypto-icons { position: relative; width: 36px; height: 36px; flex-shrink: 0; }
    .crypto-icon { width: 36px; height: 36px; border-radius: 50%; background: #222; }
    .chain-icon {
      width: 16px; height: 16px; border-radius: 50%; position: absolute; bottom: -2px; right: -4px;
      border: 2px solid var(--surface); background: #222;
    }
    .crypto-label { display: flex; flex-direction: column; }
    .crypto-name { font-weight: 700; font-size: 0.95rem; }
    .chain-name { font-size: 0.75rem; color: var(--muted); }
  </style>
</head>
<body>

<div class="checkout">
  <div class="card">
    <div class="logo">Arc<span>wright</span></div>
    
    <!-- Step 1: Email & Crypto Selection -->
    <div id="step-email" class="step active">
      <h2 id="product-name">Loading...</h2>
      <div class="price-tag" id="product-price"></div>
      
      <div class="form-group">
        <label for="email">Email (for delivery)</label>
        <input type="email" id="email" placeholder="you@example.com" required>
      </div>
      
      <div class="form-group">
        <label for="crypto">Pay with</label>
        <div class="crypto-options" id="crypto-options">
          <label class="crypto-option selected" data-value="USDC:base">
            <input type="radio" name="crypto" value="USDC:base" checked>
            <div class="crypto-option-inner">
              <div class="crypto-icons">
                <img src="https://cryptologos.cc/logos/usd-coin-usdc-logo.svg" alt="USDC" class="crypto-icon">
                <img src="https://avatars.githubusercontent.com/u/108554348?s=200" alt="Base" class="chain-icon">
              </div>
              <div class="crypto-label">
                <span class="crypto-name">USDC</span>
                <span class="chain-name">Base</span>
              </div>
            </div>
          </label>
          <label class="crypto-option" data-value="ETH:base">
            <input type="radio" name="crypto" value="ETH:base">
            <div class="crypto-option-inner">
              <div class="crypto-icons">
                <img src="https://cryptologos.cc/logos/ethereum-eth-logo.svg" alt="ETH" class="crypto-icon">
                <img src="https://avatars.githubusercontent.com/u/108554348?s=200" alt="Base" class="chain-icon">
              </div>
              <div class="crypto-label">
                <span class="crypto-name">ETH</span>
                <span class="chain-name">Base</span>
              </div>
            </div>
          </label>
          <label class="crypto-option" data-value="ETH:ethereum">
            <input type="radio" name="crypto" value="ETH:ethereum">
            <div class="crypto-option-inner">
              <div class="crypto-icons">
                <img src="https://cryptologos.cc/logos/ethereum-eth-logo.svg" alt="ETH" class="crypto-icon">
                <img src="https://cryptologos.cc/logos/ethereum-eth-logo.svg" alt="Ethereum" class="chain-icon">
              </div>
              <div class="crypto-label">
                <span class="crypto-name">ETH</span>
                <span class="chain-name">Ethereum</span>
              </div>
            </div>
          </label>
          <label class="crypto-option" data-value="SOL:solana">
            <input type="radio" name="crypto" value="SOL:solana">
            <div class="crypto-option-inner">
              <div class="crypto-icons">
                <img src="https://cryptologos.cc/logos/solana-sol-logo.svg" alt="SOL" class="crypto-icon">
                <img src="https://cryptologos.cc/logos/solana-sol-logo.svg" alt="Solana" class="chain-icon">
              </div>
              <div class="crypto-label">
                <span class="crypto-name">SOL</span>
                <span class="chain-name">Solana</span>
              </div>
            </div>
          </label>
        </div>
        <div class="crypto-preview" id="crypto-preview"></div>
      </div>
      
      <button class="btn" id="btn-pay" onclick="startPayment()">Continue to Payment</button>
    </div>
    
    <!-- Step 2: Payment Address & QR -->
    <div id="step-pay" class="step">
      <div class="payment-info">
        <h2>Send Payment</h2>
        <div class="amount-box" id="pay-amount"></div>
        <div class="amount-usd" id="pay-amount-usd"></div>
        <div class="chain-info" id="pay-chain"></div>
        
        <div class="qr-container">
          <canvas id="qr-canvas"></canvas>
        </div>
        
        <div class="address-box" id="pay-address" onclick="copyAddress()"></div>
        
        <p style="font-size:0.8rem; color:var(--muted)">Send exact amount to the address above</p>
        
        <div class="timer" id="timer">Waiting for payment...</div>
        <div id="status-container"></div>
      </div>
    </div>
    
    <!-- Step 3: Confirmed -->
    <div id="step-done" class="step">
      <div class="payment-info">
        <h2>‚úÖ Payment Confirmed!</h2>
        <p style="margin-top:12px; color:var(--muted)">Your product is ready to download:</p>
        <a id="download-btn" href="#" class="btn" style="display:inline-block; margin-top:16px; text-decoration:none; text-align:center;">‚¨á Download Product</a>
        <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-top:20px;text-align:left;">
          <p style="font-size:0.85rem;font-weight:600;margin-bottom:8px;">üìã Quick Setup</p>
          <p style="font-size:0.8rem;color:var(--muted);margin-bottom:4px;">1. Unzip and drop the files into your agent's workspace</p>
          <p style="font-size:0.8rem;color:var(--muted);">2. Follow the README.md inside for configuration</p>
        </div>
        <div id="related-products" style="margin-top:20px;text-align:left;display:none;">
          <p style="font-size:0.85rem;font-weight:600;margin-bottom:8px;">üîó You might also like</p>
          <div id="related-list"></div>
        </div>
        <p style="font-size:0.8rem; color:var(--muted); margin-top:16px;">Save your download link ‚Äî it won't expire.</p>
        <p style="font-size:0.8rem; color:var(--muted); margin-top:8px;">Need help? <a href="mailto:arcwrighthq@proton.me" style="color:var(--accent2);text-decoration:none;">Email arcwrighthq@proton.me</a></p>
        <div class="status-badge status-confirmed">Paid</div>
      </div>
    </div>
  </div>
  
  <a href="/" class="back-link">‚Üê Back to Arcwright</a>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const productSlug = params.get('product');
  let paymentId = null;
  let pollTimer = null;
  let productPriceUsd = 0;
  let livePrices = { eth: 0, sol: 0 };

  const CHAIN_LABELS = {
    'base': 'Base network',
    'ethereum': 'Ethereum mainnet',
    'solana': 'Solana',
  };

  async function loadProduct() {
    if (!productSlug) { window.location.href = '/'; return; }
    try {
      const [prodRes, priceRes] = await Promise.all([
        fetch('/api/products'),
        fetch('/api/prices'),
      ]);
      const products = await prodRes.json();
      const product = products.find(p => p.slug === productSlug);
      if (!product) { window.location.href = '/'; return; }
      
      productPriceUsd = product.price_usd;
      document.getElementById('product-name').textContent = product.name;
      document.getElementById('product-price').textContent = `$${product.price_usd}`;

      try {
        livePrices = await priceRes.json();
      } catch (e) {}
      
      updatePreview();
      
      // Bind radio button changes
      document.querySelectorAll('.crypto-option input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.querySelectorAll('.crypto-option').forEach(o => o.classList.remove('selected'));
          radio.closest('.crypto-option').classList.add('selected');
          updatePreview();
        });
      });
    } catch (err) {
      console.error('Failed to load product:', err);
    }
  }

  function getSelectedCrypto() {
    const checked = document.querySelector('input[name="crypto"]:checked');
    return checked ? checked.value : 'USDC:base';
  }

  function updatePreview() {
    const [crypto] = getSelectedCrypto().split(':');
    const el = document.getElementById('crypto-preview');
    
    if (crypto === 'USDC') {
      el.textContent = `‚âà ${productPriceUsd} USDC`;
    } else if (crypto === 'ETH' && livePrices.eth > 0) {
      el.textContent = `‚âà ${(productPriceUsd / livePrices.eth).toFixed(6)} ETH ($${livePrices.eth.toLocaleString()}/ETH)`;
    } else if (crypto === 'SOL' && livePrices.sol > 0) {
      el.textContent = `‚âà ${(productPriceUsd / livePrices.sol).toFixed(6)} SOL ($${livePrices.sol.toLocaleString()}/SOL)`;
    } else {
      el.textContent = 'Fetching price...';
    }
  }

  async function startPayment() {
    const email = document.getElementById('email').value.trim();
    if (!email || !email.includes('@')) { alert('Please enter a valid email'); return; }
    
    const [cryptoType, chain] = getSelectedCrypto().split(':');
    
    const btn = document.getElementById('btn-pay');
    btn.disabled = true;
    btn.textContent = 'Creating payment...';

    try {
      const res = await fetch('/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, product_slug: productSlug, crypto: cryptoType, chain }),
      });
      const data = await res.json();
      
      if (data.error) { alert(data.error); btn.disabled = false; btn.textContent = 'Continue to Payment'; return; }
      
      paymentId = data.payment_id;
      
      document.getElementById('step-email').classList.remove('active');
      document.getElementById('step-pay').classList.add('active');
      
      document.getElementById('pay-amount').textContent = `${data.amount_crypto} ${data.crypto}`;
      document.getElementById('pay-amount-usd').textContent = `($${data.amount_usd} USD)`;
      document.getElementById('pay-chain').textContent = `on ${CHAIN_LABELS[data.chain] || data.chain}`;
      document.getElementById('pay-address').textContent = data.pay_address;
      
      QRCode.toCanvas(document.getElementById('qr-canvas'), data.pay_address, {
        width: 200, margin: 2,
        color: { dark: '#e8e8e8', light: '#141414' }
      });
      
      startPolling(data.expires_in_minutes);
      
    } catch (err) {
      alert('Payment creation failed. Please try again.');
      btn.disabled = false;
      btn.textContent = 'Continue to Payment';
    }
  }

  function startPolling(expiresMin) {
    const expireTime = Date.now() + expiresMin * 60 * 1000;
    
    pollTimer = setInterval(async () => {
      const remaining = Math.max(0, expireTime - Date.now());
      const min = Math.floor(remaining / 60000);
      const sec = Math.floor((remaining % 60000) / 1000);
      document.getElementById('timer').textContent = remaining > 0 
        ? `Expires in ${min}:${sec.toString().padStart(2, '0')}`
        : 'Payment expired';
      
      if (remaining <= 0) {
        clearInterval(pollTimer);
        document.getElementById('status-container').innerHTML = '<div class="status-badge status-expired">Expired</div>';
        return;
      }
      
      try {
        const res = await fetch(`/api/payment/${paymentId}`);
        const data = await res.json();
        
        if (data.status === 'confirmed' || data.status === 'delivered') {
          clearInterval(pollTimer);
          document.getElementById('step-pay').classList.remove('active');
          document.getElementById('step-done').classList.add('active');
          if (data.download_url) {
            document.getElementById('download-btn').href = data.download_url;
          }
          showRelated();
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    }, 5000);
  }

  function copyAddress() {
    const addr = document.getElementById('pay-address').textContent;
    navigator.clipboard.writeText(addr).then(() => {
      const el = document.getElementById('pay-address');
      const orig = el.textContent;
      el.textContent = '‚úì Copied!';
      setTimeout(() => { el.textContent = orig; }, 1500);
    });
  }

  // Related products suggestions
  const RELATED = {
    'proactive-agent-playbook': [
      { name: 'Maven ‚Äî Marketing Mega Bundle', slug: 'marketing-mega-bundle', price: 49, desc: '12 marketing skills in one bundle' },
      { name: 'Crypto Wallet Manager', slug: 'crypto-wallet-manager', price: 19, desc: 'Multi-chain wallet management' },
    ],
    'crypto-wallet-manager': [
      { name: 'Maven ‚Äî Marketing Mega Bundle', slug: 'marketing-mega-bundle', price: 49, desc: '12 marketing skills in one bundle' },
      { name: 'Proactive Agent Playbook', slug: 'proactive-agent-playbook', price: 19, desc: 'Turn passive agents proactive' },
    ],
    'marketing-mega-bundle': [
      { name: 'Proactive Agent Playbook', slug: 'proactive-agent-playbook', price: 19, desc: 'Turn passive agents proactive' },
      { name: 'Crypto Wallet Manager', slug: 'crypto-wallet-manager', price: 19, desc: 'Multi-chain wallet management' },
    ],
  };

  function showRelated() {
    const related = RELATED[productSlug];
    if (!related) return;
    const container = document.getElementById('related-products');
    const list = document.getElementById('related-list');
    container.style.display = 'block';
    related.forEach(r => {
      const el = document.createElement('a');
      el.href = `/product.html?slug=${r.slug}`;
      el.style.cssText = 'display:block;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;text-decoration:none;color:var(--text);transition:border-color 0.2s;';
      el.innerHTML = `<span style="font-weight:600;font-size:0.85rem;">${r.name}</span> <span style="color:var(--accent);font-weight:700;font-size:0.85rem;">$${r.price}</span><br><span style="font-size:0.8rem;color:var(--muted);">${r.desc}</span>`;
      el.onmouseenter = () => el.style.borderColor = '#444';
      el.onmouseleave = () => el.style.borderColor = 'var(--border)';
      list.appendChild(el);
    });
  }

  loadProduct();
</script>

</body>
</html>
